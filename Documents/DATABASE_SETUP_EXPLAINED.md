# Database Setup for Distribution

## Overview

The Foodie app uses a **seed database** that gets copied to user data on first run. This document explains how the database system works and how to update it with scraped recipes.

---

## Database Locations

### 1. Seed Database (Shipped with App)
```
data/foodie.sqlite
```
- This is the **master seed** database included with the app
- On first run, it's copied to the user's Application Support folder
- When distributing the app, this file is included in the package
- **This is what you need to update** after scraping recipes

### 2. User Data Database (Runtime)
```
~/Library/Application Support/Foodie Meal Planner/foodie.sqlite
```
- Created on first app launch
- Contains user's actual data (meal plans, shopping lists, etc.)
- Seeded from `data/foodie.sqlite` if empty
- **This is what the running app uses**

### 3. Scraped Database (Temporary)
```
data/foodie-scraped.sqlite
```
- Generated by the recipe scraper
- Contains newly scraped recipes
- Used to update the seed database

---

## How It Works

### First Run (New Installation)
```
1. App starts
2. Checks: Does user data DB exist?
3. If NO â†’ Copy data/foodie.sqlite to Application Support
4. App uses the Application Support database
```

### Subsequent Runs
```
1. App starts
2. User data DB exists â†’ Use it directly
3. Any changes (meal plans, shopping lists) saved here
```

### After Scraping New Recipes
```
1. Scraper creates: data/foodie-scraped.sqlite
2. Run: ./scraper-manager.sh replace-main
3. Updates data/foodie.sqlite (seed)
4. Updates user data database
5. Next app launch uses new recipes
```

---

## Updating Seed Database After Scraping

### Automatic (Recommended)

After scraping recipes, run:

```bash
./scraper-manager.sh replace-main
```

This will:
1. âœ… Backup current seed database
2. âœ… Replace `data/foodie.sqlite` with scraped recipes
3. âœ… Backup user data database
4. âœ… Update user data with new recipes
5. âœ… Verify everything matches

### Manual (If Needed)

```bash
# Just update seed and user data
./update-seed-database.sh
```

This script:
- Copies `data/foodie-scraped.sqlite` â†’ `data/foodie.sqlite`
- Replaces user data database with new seed
- Creates backups of old databases in `data/backups/`

---

## Recipe Counts

After updating (as of January 18, 2026):

```
Seed DB:      3,532 recipes (from scraper)
User DB:      3,532 recipes (matches seed)
Scraped DB:   3,532 recipes (source)
```

**Old database had 13,478 recipes** (backed up to `data/backups/`)

---

## For Distribution

### Development
Current state is ready:
- `data/foodie.sqlite` has 3,532 scraped recipes
- This file will be included when packaging the app
- Users will get these recipes on first launch

### Packaging for Distribution

When building the app for distribution (via `npm run build` or Electron Packager):

1. **Seed database is included:**
   ```
   FoodieApp.app/Contents/Resources/data/foodie.sqlite
   ```

2. **On user's first launch:**
   - App copies seed DB to their Application Support folder
   - User starts with 3,532 recipes

3. **Users can then:**
   - Add their own recipes
   - Create meal plans
   - Generate shopping lists
   - Data stays in their Application Support folder

---

## Backup Strategy

All backups are stored in:
```
data/backups/
```

**Automatic backups created:**
- When replacing seed database
- When updating user data
- Format: `foodie-[type]-backup-[timestamp].sqlite`

**Example backups:**
```
data/backups/foodie-seed-backup-20260118_093405.sqlite     (3,532 recipes)
data/backups/foodie-userdata-backup-20260118_093405.sqlite (13,478 old recipes)
```

---

## Common Scenarios

### Scenario 1: Just Scraped New Recipes

```bash
# After scraper completes
./scraper-manager.sh replace-main

# App is now ready with new recipes
npm start
```

### Scenario 2: Want to Revert to Old Recipes

```bash
# Find your backup
ls -lh data/backups/

# Copy it back
cp data/backups/foodie-userdata-backup-20260118_093405.sqlite \
   ~/Library/Application\ Support/Foodie\ Meal\ Planner/foodie.sqlite

# Restart app
```

### Scenario 3: Fresh Start

```bash
# Remove user data
rm ~/Library/Application\ Support/Foodie\ Meal\ Planner/foodie.sqlite

# Next launch will reseed from data/foodie.sqlite
npm start
```

### Scenario 4: Building for Distribution

```bash
# Make sure seed is updated
./update-seed-database.sh

# Verify recipe count
sqlite3 data/foodie.sqlite "SELECT COUNT(*) FROM recipes;"
# Should show: 3532

# Build the app
npm run build

# Seed database is included in the package
```

---

## Verification Commands

### Check Recipe Counts

```bash
# Seed database
sqlite3 data/foodie.sqlite "SELECT COUNT(*) FROM recipes;"

# User data
sqlite3 ~/Library/Application\ Support/Foodie\ Meal\ Planner/foodie.sqlite \
  "SELECT COUNT(*) FROM recipes;"

# Scraped database
sqlite3 data/foodie-scraped.sqlite "SELECT COUNT(*) FROM recipes;"
```

### Check File Sizes

```bash
ls -lh data/*.sqlite
ls -lh ~/Library/Application\ Support/Foodie\ Meal\ Planner/foodie.sqlite
```

### Check Latest Recipes

```bash
# See newest recipes in seed
sqlite3 data/foodie.sqlite \
  "SELECT Title, CreatedAt FROM recipes ORDER BY CreatedAt DESC LIMIT 10;"
```

---

## Troubleshooting

### "App still shows old recipes"

**Cause:** User data database wasn't updated

**Fix:**
```bash
./update-seed-database.sh
```

### "Recipe count doesn't match"

**Verify all databases:**
```bash
echo "Seed:"; sqlite3 data/foodie.sqlite "SELECT COUNT(*) FROM recipes;"
echo "User:"; sqlite3 ~/Library/Application\ Support/Foodie\ Meal\ Planner/foodie.sqlite "SELECT COUNT(*) FROM recipes;"
echo "Scraped:"; sqlite3 data/foodie-scraped.sqlite "SELECT COUNT(*) FROM recipes;"
```

**If mismatched, run:**
```bash
./update-seed-database.sh
```

### "Lost my recipes!"

**Check backups:**
```bash
ls -lht data/backups/
```

**Restore from backup:**
```bash
# Choose your backup file
cp data/backups/foodie-userdata-backup-TIMESTAMP.sqlite \
   ~/Library/Application\ Support/Foodie\ Meal\ Planner/foodie.sqlite
```

---

## Summary

âœ… **Current State (After Running update-seed-database.sh):**
- Seed database: 3,532 scraped recipes
- User database: 3,532 recipes (matches seed)
- Ready for development and distribution

âœ… **For Future Scraping:**
```bash
# 1. Scrape recipes
./scraper-manager.sh scrape

# 2. Replace databases
./scraper-manager.sh replace-main
# (Automatically runs update-seed-database.sh)

# 3. Done!
```

âœ… **For Distribution:**
- `data/foodie.sqlite` is automatically included
- Users get 3,532 recipes on first launch
- Everything is backed up safely

---

## Files Reference

| File | Purpose | Recipe Count |
|------|---------|--------------|
| `data/foodie.sqlite` | **Seed database** (ships with app) | 3,532 |
| `~/Library/.../foodie.sqlite` | **User data** (runtime) | 3,532 |
| `data/foodie-scraped.sqlite` | Scraper output (temp) | 3,532 |
| `data/backups/*` | Safety backups | Various |

---

**Scripts:**
- `./scraper-manager.sh replace-main` - Full replacement workflow
- `./update-seed-database.sh` - Update seed + user data only
- `./scraper-manager.sh scrape` - Run recipe scraper

**Ready to distribute!** ðŸŽ‰
